name: Daily Podcast Automation

on:
  schedule:
    - cron: '0 22 * * *' # æ¯å¤©å°ç£æ™‚é–“æ—©ä¸Š 6:00 åŸ·è¡Œ
  workflow_dispatch:

jobs:
  generate_podcast:
    runs-on: ubuntu-latest
    env:
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      VOICE_ID: 'D9bZgM9Er0PhIxuW9Jqa'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm install axios dayjs

      - name: Generate Script (Grok)
        run: |
          node -e "
          const axios = require('axios');
          const fs = require('fs');

          async function main() {
            const apiKey = process.env.GROK_API_KEY;
            if (!apiKey) throw new Error('âŒ éŒ¯èª¤ï¼šGROK_API_KEY æœªè¨­å®šï¼Œè«‹æª¢æŸ¥ GitHub Secretsï¼');

            try {
              const res = await axios.post('https://api.grok.x.ai/v1/chat/completions', {
                model: 'grok-1',
                messages: [{
                  role: 'system',
                  content: 'ä½ æ˜¯å°ç£ä¸­å¹´å¤§å”æ’­å ±å“¡ï¼Œè«‹ç”Ÿæˆ12åˆ†é˜ç¹é«”ä¸­æ–‡æ’­å ±è…³æœ¬ã€‚å…§å®¹é ˆå«ï¼šç¾è‚¡å››å¤§æŒ‡æ•¸(.DJI, .IXIC, .SPX, SOX)æ”¶ç›¤ã€QQQå’ŒSPY ETFã€æ¯”ç‰¹å¹£èˆ‡é»ƒé‡‘æœŸè²¨å ±åƒ¹ã€Top5ç†±é–€è‚¡ã€è³‡é‡‘æµå‘ã€æœ€æ–°AIæ–°èã€ç¸½é«”ç¶“æ¿Ÿæ–°èï¼Œæœ€å¾Œä»¥æŠ•è³‡é‡‘å¥ä½œçµã€‚èªæ°£è¦ªåˆ‡è‡ªç„¶ï¼Œèªé€Ÿç´„1.3å€ï¼Œæ‰€æœ‰æ•¸æ“šå¿…é ˆæº–ç¢ºä¸”ç¶“äº¤å‰é©—è­‰ã€‚'
                }]
              }, {
                headers: { Authorization: \`Bearer \${apiKey}\` }
              });

              if (!res.data.choices || !res.data.choices.length) {
                throw new Error('âŒ éŒ¯èª¤ï¼šGrok API ç„¡è¿”å›å…§å®¹ï¼Œè«‹æª¢æŸ¥ API ç‹€æ…‹ï¼');
              }

              fs.writeFileSync('script.txt', res.data.choices[0].message.content);
            } catch (err) {
              throw new Error(\`âŒ Grok API å‘¼å«å¤±æ•—ï¼š\${err.message}\`);
            }
          }

          main();
          "

      - name: Check script file
        run: |
          [ -s script.txt ] || { echo "âŒ éŒ¯èª¤ï¼šè…³æœ¬ script.txt æœªç”Ÿæˆæˆ–å…§å®¹ç‚ºç©º"; exit 1; }

      - name: Generate Audio (ElevenLabs)
        run: |
          node -e "
          const axios = require('axios');
          const fs = require('fs');
          const dayjs = require('dayjs');

          async function main() {
            const apiKey = process.env.ELEVENLABS_API_KEY;
            if (!apiKey) throw new Error('âŒ éŒ¯èª¤ï¼šELEVENLABS_API_KEY æœªè¨­å®šï¼Œè«‹æª¢æŸ¥ GitHub Secretsï¼');

            const text = fs.readFileSync('script.txt', 'utf8');
            const dateStr = dayjs().format('YYYYMMDD');

            try {
              const res = await axios({
                method: 'post',
                url: \`https://api.elevenlabs.io/v1/text-to-speech/\${process.env.VOICE_ID}/stream\`,
                headers: {
                  'xi-api-key': apiKey,
                  'Content-Type': 'application/json'
                },
                data: { text, voice_settings: { stability: 0.3, similarity_boost: 0.8 } },
                responseType: 'arraybuffer'
              });

              fs.mkdirSync('audio', { recursive: true });
              fs.writeFileSync(\`audio/daily_podcast_\${dateStr}.mp3\`, res.data);
            } catch (err) {
              throw new Error(\`âŒ ElevenLabs API å‘¼å«å¤±æ•—ï¼š\${err.message}\`);
            }
          }

          main();
          "

      - name: Check audio file
        run: |
          FILE="audio/daily_podcast_$(date +%Y%m%d).mp3"
          [ -f "$FILE" ] || { echo "âŒ éŒ¯èª¤ï¼šèªéŸ³æª”æ¡ˆæœªç”Ÿæˆ"; exit 1; }

      - name: Generate RSS Feed
        run: |
          node -e "
          const fs = require('fs');
          const dayjs = require('dayjs');
          const dateSlug = dayjs().format('YYYYMMDD');
          const pubDate = dayjs().format('ddd, DD MMM YYYY HH:mm:ss ZZ');
          const audioPath = \`audio/daily_podcast_\${dateSlug}.mp3\`;
          const audioSize = fs.statSync(audioPath).size;

          const rss = \`
          <rss version='2.0' xmlns:itunes='http://www.itunes.com/dtds/podcast-1.0.dtd'>
            <channel>
              <title>å¤§å”èªªè²¡ç¶“ç§‘æŠ€æŠ•è³‡</title>
              <link>https://ä½ çš„å¸³è™Ÿ.github.io/daily-podcast-stk/</link>
              <language>zh-tw</language>
              <itunes:image href='https://ä½ çš„å¸³è™Ÿ.github.io/daily-podcast-stk/cover.jpg'/>
              <item>
                <title>\${dateSlug} æ¯æ—¥æ’­å ±</title>
                <enclosure url='https://ä½ çš„å¸³è™Ÿ.github.io/daily-podcast-stk/\${audioPath}' length='\${audioSize}' type='audio/mpeg'/>
                <guid>https://ä½ çš„å¸³è™Ÿ.github.io/daily-podcast-stk/\${audioPath}</guid>
                <pubDate>\${pubDate}</pubDate>
                <itunes:duration>12:00</itunes:duration>
              </item>
            </channel>
          </rss>\`;

          fs.writeFileSync('feed.xml', rss.trim());
          "

      - name: Commit and Push Changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add audio/*.mp3 feed.xml script.txt
          git commit -m "ğŸŸ¢ æ¯æ—¥Podcastè‡ªå‹•æ›´æ–°ï¼š$(date +%Y%m%d)" || echo "âœ… ç„¡æ›´æ–°å¯æäº¤"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
