name: Podcast Workflow Pipeline

# å®šç¾©è§¸ç™¼æ¢ä»¶
on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: '0 21 * * *'  # å°ç£æ™‚é–“ 5:00 AM (æ¯æ—¥)
    - cron: '0 5,14,18 * * *'  # å°ç£æ™‚é–“ 1:45 PM, 6:00 PM, 10:00 PM
    - cron: '0 * * * *'  # æ¯å°æ™‚ (ç­–ç•¥ç®¡ç†å¸«)
    - cron: '0 22,6 * * *'  # å°ç£æ™‚é–“ 6:00 AM, 2:00 PM (æ’­å®¢ç›¸é—œ)

env:
  WORKING_DIR: 'repo'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: ${{ env.WORKING_DIR }}
      - name: Verify Repository Structure
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pwd
          ls -la
          for dir in scripts data logs docs/podcast docs/rss; do
            mkdir -p "$dir" || echo "ç›®éŒ„ $dir å·²å­˜åœ¨"
          done
          if [ ! -f "config.json" ]; then
            echo '{"symbols": ["0050.TW", "QQQ", "^TWII", "BTC-USD"]}' > config.json
          fi
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy backtrader scikit-learn tensorflow requests feedparser edge-tts b2sdk

  data-collection:
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.schedule == '0 21 * * *' || github.event.schedule == '0 5,14,18 * * *'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: ${{ env.WORKING_DIR }}
      - name: Run Data Collector
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“¥ åŸ·è¡Œè³‡æ–™æ”¶é›†å“¡"
          if [ ! -f "scripts/data_collector.py" ]; then
            echo "å‰µå»ºæ¨¡æ“¬ data_collector.py"
            cat > scripts/data_collector.py << 'EOF'
import os
import pandas as pd
import yfinance as yf
from datetime import datetime

def fetch_data(symbol):
    df = yf.download(symbol, period="300d" if "daily" in symbol else "14d", interval="1h" if "hourly" in symbol else "1d")
    return df

def validate_data(df, symbol):
    if df.empty or 'Close' not in df.columns:
        raise ValueError(f"æ•¸æ“šç¼ºå¤±: {symbol}")
    change = (df['Close'].iloc[-1] - df['Close'].iloc[0]) / df['Close'].iloc[0] * 100
    if abs(change) > 20:
        print(f"è­¦å‘Š: {symbol} æ¼²è·Œå¹…åº¦ {change:.2f}% ç•°å¸¸")
    return df

symbols = eval(open("config.json").read())["symbols"]
for symbol in symbols:
    try:
        df = fetch_data(symbol)
        df = validate_data(df, symbol)
        os.makedirs("data", exist_ok=True)
        df.to_csv(f"data/daily_{symbol}.csv" if "daily" in symbol else f"data/hourly_{symbol}.csv")
        with open("logs/data_collector.log", "a") as f:
            f.write(f"{datetime.now()}: {symbol} æ•¸æ“šæ”¶é›†å®Œæˆ, ç­†æ•¸: {len(df)}\n")
    except Exception as e:
        with open("logs/data_collector.log", "a") as f:
            f.write(f"{datetime.now()}: éŒ¯èª¤ - {symbol}: {str(e)}\n")
EOF
          fi
          python scripts/data_collector.py
        continue-on-error: false

  strategy-management:
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.schedule == '0 * * * *'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: ${{ env.WORKING_DIR }}
      - name: Run Strategy Manager
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ¤– åŸ·è¡Œç­–ç•¥ç®¡ç†å¸«"
          if [ ! -f "scripts/strategy_manager.py" ]; then
            echo "å‰µå»ºæ¨¡æ“¬ strategy_manager.py"
            cat > scripts/strategy_manager.py << 'EOF'
import os
import json
import pandas as pd
import backtrader as bt
from datetime import datetime

class Strategy(bt.Strategy):
    params = (("period", 15),)

    def __init__(self):
        self.sma = bt.indicators.SMA(self.data.close, period=self.params.period)

    def next(self):
        if not self.position:
            if self.data.close[0] > self.sma[0]:
                self.buy()
        elif self.data.close[0] < self.sma[0]:
            self.sell()

def run_strategy(symbol):
    cerebro = bt.Cerebro()
    data = bt.feeds.PandasData(dataname=pd.read_csv(f"data/daily_{symbol}.csv"))
    cerebro.adddata(data)
    cerebro.addstrategy(Strategy)
    cerebro.run()
    return cerebro.broker.getvalue()

symbols = eval(open("config.json").read())["symbols"]
for symbol in symbols:
    try:
        value = run_strategy(symbol)
        result = {"symbol": symbol, "value": value, "timestamp": datetime.now().isoformat()}
        os.makedirs("data", exist_ok=True)
        with open(f"data/strategy_best_{symbol}.json", "w") as f:
            json.dump(result, f)
        with open("logs/strategy_manager.log", "a") as f:
            f.write(f"{datetime.now()}: {symbol} ç­–ç•¥é‹è¡Œå®Œæˆ, åƒ¹å€¼: {value}\n")
    except Exception as e:
        with open("logs/strategy_manager.log", "a") as f:
            f.write(f"{datetime.now()}: éŒ¯èª¤ - {symbol}: {str(e)}\n")
EOF
          fi
          python scripts/strategy_manager.py
        continue-on-error: false

  podcast-stages:
    runs-on: ubuntu-latest
    needs: [setup, data-collection, strategy-management]
    if: github.event.schedule == '0 22 * * *' || github.event.schedule == '6 * * *'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: ${{ env.WORKING_DIR }}
      - name: Set Date and Mode
        id: set-date-mode
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          DATE_STR=$(date +%Y%m%d)
          HOUR=$(date +%H)
          if [ "$HOUR" = "06" ]; then
            MODE="us"
          elif [ "$HOUR" = "14" ]; then
            MODE="tw"
          else
            MODE="tw"
          fi
          echo "DATE_STR=$DATE_STR" >> $GITHUB_ENV
          echo "PODCAST_MODE=$MODE" >> $GITHUB_ENV
      - name: Run Script Editor
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "âœï¸ åŸ·è¡Œæ–‡å­—ç·¨è¼¯å¸«"
          mkdir -p "docs/podcast/${{ env.DATE_STR }}_${{ env.PODCAST_MODE }}"
          if [ ! -f "scripts/script_editor.py" ]; then
            echo "å‰µå»ºæ¨¡æ“¬ script_editor.py"
            cat > scripts/script_editor.py << 'EOF'
import os
from datetime import datetime

def generate_script(mode):
    script = f"é€™æ˜¯ {mode} æ’­å®¢è…³æœ¬ - {datetime.now().strftime('%Y%m%d')}"
    dir_path = f"docs/podcast/{datetime.now().strftime('%Y%m%d')}_{mode}"
    os.makedirs(dir_path, exist_ok=True)
    with open(f"{dir_path}/script.txt", "w") as f:
        f.write(script)
    with open("logs/script_editor.log", "a") as f:
        f.write(f"{datetime.now()}: è…³æœ¬ç”Ÿæˆå®Œæˆ\n")

generate_script(os.getenv("PODCAST_MODE", "tw"))
EOF
          fi
          python scripts/script_editor.py
        continue-on-error: false
      - name: Run Podcast Producer
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ™ï¸ åŸ·è¡Œæ’­å ±å“¡"
          if [ ! -f "scripts/podcast_producer.py" ]; then
            echo "å‰µå»ºæ¨¡æ“¬ podcast_producer.py"
            cat > scripts/podcast_producer.py << 'EOF'
import os
from datetime import datetime

def generate_audio(mode):
    dir_path = f"docs/podcast/{datetime.now().strftime('%Y%m%d')}_{mode}"
    with open(f"{dir_path}/audio.mp3", "w") as f:
        f.write("æ¨¡æ“¬éŸ³é »")
    with open("logs/podcast_producer.log", "a") as f:
        f.write(f"{datetime.now()}: éŸ³é »ç”Ÿæˆå®Œæˆ\n")

generate_audio(os.getenv("PODCAST_MODE", "tw"))
EOF
          fi
          python scripts/podcast_producer.py
        continue-on-error: false
      - name: Run Upload Manager
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "â˜ï¸ åŸ·è¡Œé›²ç«¯ä¸Šå‚³å“¡"
          if [ ! -f "scripts/upload_manager.py" ]; then
            echo "å‰µå»ºæ¨¡æ“¬ upload_manager.py"
            cat > scripts/upload_manager.py << 'EOF'
import os
from datetime import datetime

def upload_file(mode):
    dir_path = f"docs/podcast/{datetime.now().strftime('%Y%m%d')}_{mode}"
    with open(f"{dir_path}/archive_audio_url.txt", "w") as f:
        f.write("https://example.com/audio.mp3")
    with open("logs/upload_manager.log", "a") as f:
        f.write(f"{datetime.now()}: ä¸Šå‚³å®Œæˆ\n")

upload_file(os.getenv("PODCAST_MODE", "tw"))
EOF
          fi
          python scripts/upload_manager.py
        continue-on-error: false
      - name: Run Feed Publisher
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“¡ åŸ·è¡Œæ¨æ’­å“¡"
          if [ ! -f "scripts/feed_publisher.py" ]; then
            echo "å‰µå»ºæ¨¡æ“¬ feed_publisher.py"
            cat > scripts/feed_publisher.py << 'EOF'
import os
from datetime import datetime

def publish_feed(mode):
    dir_path = "docs/rss"
    os.makedirs(dir_path, exist_ok=True)
    with open(f"{dir_path}/podcast_{mode}.xml", "w") as f:
        f.write(f"<rss><channel><title>{mode} Podcast</title></channel></rss>")
    with open("logs/feed_publisher.log", "a") as f:
        f.write(f"{datetime.now()}: RSS ç™¼å¸ƒå®Œæˆ\n")

publish_feed(os.getenv("PODCAST_MODE", "tw"))
EOF
          fi
          python scripts/feed_publisher.py
        continue-on-error: false

  cleanup:
    runs-on: ubuntu-latest
    needs: podcast-stages
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: ${{ env.WORKING_DIR }}
      - name: Cleanup Old Files
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          find docs/podcast -type f -mtime +14 -exec rm -v {} \;
          echo "å·²åˆªé™¤ 14 å¤©å‰æª”æ¡ˆ"
