name: Test Podcast Workflow

# æ‰‹å‹•è§¸ç™¼ä»¥ä¾¿æ¸¬è©¦
on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨è©³ç´° debug æ¨¡å¼'
        required: false
        default: 'true'

# å®šç¾©ä½œæ¥­ç’°å¢ƒ
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: ./  # ç¢ºä¿æª¢æŸ¥åˆ°æ ¹ç›®éŒ„ï¼Œé¿å…é‡è¤‡å€‰åº«åç¨±
      - name: Verify Repository Structure
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ“‹ é©—è­‰å€‰åº«çµæ§‹"
          ls -la
          if [ ! -d "scripts" ]; then echo "âŒ ç¼ºå°‘ scripts ç›®éŒ„"; exit 1; fi
          if [ ! -f "config.json" ]; then echo "âŒ ç¼ºå°‘ config.json"; exit 1; fi
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Dependencies
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ“¦ å®‰è£ä¾è³´"
          pip install yfinance pandas backtrader numpy scikit-learn tensorflow requests feedparser edge-tts b2sdk
      - name: Set Environment Variables
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ”‘ è¨­å®šç’°å¢ƒè®Šæ•¸"
          echo "GROK_API_KEY=${{ secrets.GROK_API_KEY }}" >> $GITHUB_ENV
          echo "B2_KEY_ID=${{ secrets.B2_KEY_ID }}" >> $GITHUB_ENV
          echo "B2_APPLICATION_KEY=${{ secrets.B2_APPLICATION_KEY }}" >> $GITHUB_ENV
          echo "B2_BUCKET_NAME=${{ secrets.B2_BUCKET_NAME }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV

  data-collection:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Run Data Collector
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ“¥ é–‹å§‹åŸ·è¡Œè³‡æ–™æ”¶é›†å“¡ (Data Collector)"
          python scripts/data_collector.py
          if [ $? -ne 0 ]; then
            echo "âŒ è³‡æ–™æ”¶é›†å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/data_collector.log"
            exit 1
          fi
          echo "âœ… è³‡æ–™æ”¶é›†å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ CSV æª”æ¡ˆ: ls -la data/"
        continue-on-error: false

  strategy-management:
    runs-on: ubuntu-latest
    needs: data-collection
    steps:
      - name: Run Strategy Manager
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ¤– é–‹å§‹åŸ·è¡Œç­–ç•¥ç®¡ç†å¸« (Strategy Manager)"
          python scripts/strategy_manager.py
          if [ $? -ne 0 ]; then
            echo "âŒ ç­–ç•¥ç®¡ç†å¸«åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/strategy_manager.log"
            exit 1
          fi
          echo "âœ… ç­–ç•¥ç®¡ç†å¸«åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ strategy_best_*.json: ls -la data/strategy_best_*.json"
        continue-on-error: false

  market-analysis:
    runs-on: ubuntu-latest
    needs: strategy-management
    steps:
      - name: Run Market Analyst
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ“Š é–‹å§‹åŸ·è¡Œå¸‚å ´åˆ†æå¸« (Market Analyst)"
          python scripts/market_analyst.py
          if [ $? -ne 0 ]; then
            echo "âŒ å¸‚å ´åˆ†æå¸«åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/market_analyst.log"
            exit 1
          fi
          echo "âœ… å¸‚å ´åˆ†æå¸«åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ market_analysis_*.json: ls -la data/market_analysis_*.json"
        continue-on-error: false

  script-editing:
    runs-on: ubuntu-latest
    needs: market-analysis
    steps:
      - name: Run Script Editor
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "âœï¸ é–‹å§‹åŸ·è¡Œæ–‡å­—ç·¨è¼¯å¸« (Script Editor)"
          python scripts/script_editor.py
          if [ $? -ne 0 ]; then
            echo "âŒ æ–‡å­—ç·¨è¼¯å¸«åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/script_editor.log"
            exit 1
          fi
          echo "âœ… æ–‡å­—ç·¨è¼¯å¸«åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/podcast/YYYYMMDD_*/script.txt: ls -la docs/podcast/$(date +%Y%m%d)_*/script.txt"
        continue-on-error: false
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

  podcast-production:
    runs-on: ubuntu-latest
    needs: script-editing
    steps:
      - name: Run Podcast Producer
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ™ï¸ é–‹å§‹åŸ·è¡Œæ’­å ±å“¡ (Podcast Producer)"
          python scripts/podcast_producer.py
          if [ $? -ne 0 ]; then
            echo "âŒ æ’­å ±å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/podcast_producer.log"
            exit 1
          fi
          echo "âœ… æ’­å ±å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/podcast/YYYYMMDD_*/audio.mp3: ls -la docs/podcast/$(date +%Y%m%d)_*/audio.mp3"
        continue-on-error: false

  upload-management:
    runs-on: ubuntu-latest
    needs: podcast-production
    steps:
      - name: Run Upload Manager
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "â˜ï¸ é–‹å§‹åŸ·è¡Œé›²ç«¯ä¸Šå‚³å“¡ (Upload Manager)"
          python scripts/upload_manager.py
          if [ $? -ne 0 ]; then
            echo "âŒ é›²ç«¯ä¸Šå‚³å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/upload_manager.log"
            exit 1
          fi
          echo "âœ… é›²ç«¯ä¸Šå‚³å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/podcast/YYYYMMDD_*/archive_audio_url.txt: ls -la docs/podcast/$(date +%Y%m%d)_*/archive_audio_url.txt"
        continue-on-error: false
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}

  feed-publishing:
    runs-on: ubuntu-latest
    needs: upload-management
    steps:
      - name: Run Feed Publisher
        run: |
          cd ./  # åˆ‡æ›åˆ°æ ¹ç›®éŒ„
          echo "ğŸ“¡ é–‹å§‹åŸ·è¡Œæ¨æ’­å“¡ (Feed Publisher)"
          python scripts/feed_publisher.py
          if [ $? -ne 0 ]; then
            echo "âŒ æ¨æ’­å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/feed_publisher.log"
            exit 1
          fi
          echo "âœ… æ¨æ’­å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/rss/podcast_*.xml: ls -la docs/rss/podcast_*.xml"
        continue-on-error: false
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
