name: Test Data Collection Workflow

# æ‰‹å‹•è§¸ç™¼ä»¥ä¾¿æ¸¬è©¦ï¼Œæ–°å¢žæ¨¡æ“¬æ¨¡å¼é¸é …
on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨è©³ç´° debug æ¨¡å¼'
        required: false
        default: 'true'
        type: boolean
      podcast_mode:
        description: 'æ’­å®¢æ¨¡å¼ (tw/us/auto)'
        required: true
        default: 'auto'
        type: choice
        options:
          - tw
          - us
          - auto
      simulate_time:
        description: 'æ¨¡æ“¬æ™‚é–“ (HH:MM CST, ä¾‹å¦‚ 06:00 æˆ– 14:00)'
        required: false
        default: '18:40'  # ç•¶å‰æ™‚é–“ç´„ 18:40 CST

# å®šç¾©ä½œæ¥­ç’°å¢ƒ
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo  # ç›´æŽ¥ä½¿ç”¨ repo ä½œç‚ºå–®ä¸€ç›®éŒ„
      - name: Verify Repository Structure
        working-directory: repo
        run: |
          echo "ðŸ“‹ é©—è­‰å€‰åº«çµæ§‹"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la  # åˆ—å‡ºæ‰€æœ‰æª”æ¡ˆå’Œç›®éŒ„
          for dir in scripts data logs; do
            if [ ! -d "$dir" ]; then 
              echo "âš ï¸  å‰µå»ºç¼ºå°‘çš„ç›®éŒ„: $dir"
              mkdir -p "$dir"
            fi
          done
          ls -la scripts/ || echo "âš ï¸  scripts ç›®éŒ„ç‚ºç©º"
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Dependencies
        working-directory: repo
        run: |
          echo "ðŸ“¦ å®‰è£ä¾è³´"
          pip install --upgrade pip
          pip install yfinance pandas numpy
      - name: Set Environment Variables
        working-directory: repo
        run: |
          echo "ðŸ”‘ è¨­å®šç’°å¢ƒè®Šæ•¸"
          SIMULATED_HOUR=$(echo ${{ inputs.simulate_time }} | cut -d':' -f1)
          if [ "$SIMULATED_HOUR" = "06" ]; then
            echo "PODCAST_MODE=us" >> $GITHUB_ENV
          elif [ "$SIMULATED_HOUR" = "14" ]; then
            echo "PODCAST_MODE=tw" >> $GITHUB_ENV
          else
            echo "PODCAST_MODE=${{ github.event.inputs.podcast_mode || 'auto' }}" >> $GITHUB_ENV
          fi
          echo "MODE=manual" >> $GITHUB_ENV
          echo "MANUAL_TRIGGER=1" >> $GITHUB_ENV
          echo "DATA_DIR=data" >> $GITHUB_ENV
          echo "DEBUG_MODE=${{ inputs.debug_mode }}" >> $GITHUB_ENV

    data-collection:
      runs-on: ubuntu-latest
      needs: setup
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v3
          with:
            path: repo
        - name: Run Data Collector
          working-directory: repo
          run: |
            echo "ðŸ“¥ é–‹å§‹åŸ·è¡Œè³‡æ–™æ”¶é›†å“¡ (Data Collector) - æ¨¡å¼: $PODCAST_MODE"
            pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
            ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
            mkdir -p logs
            if [ ! -f "scripts/data_collector.py" ]; then
              echo "âš ï¸  data_collector.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
              cat > scripts/data_collector.py << 'EOF'
            import os
            import pandas as pd
            from datetime import datetime

    def main():
        print(f"æ•¸æ“šæ”¶é›†é–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
        data_dir = os.getenv('DATA_DIR', 'data')
        os.makedirs(data_dir, exist_ok=True)
        dates = pd.date_range('2024-01-01', periods=100, freq='D')
        prices = 100 + (pd.Series(range(100)) * 0.1)
        df = pd.DataFrame({'Date': dates, 'Close': prices})
        filename = f"{data_dir}/daily_0050.TW.csv"
        df.to_csv(filename, index=False)
        print(f"âœ… æ•¸æ“šå·²ä¿å­˜åˆ°: {filename}")
        with open("logs/data_collector.log", "w") as f:
            f.write(f"{datetime.now()}: Data collection completed\n")
    
        if __name__ == "__main__":
            main()
        EOF
              fi
              python scripts/data_collector.py
              if [ $? -ne 0 ]; then
                echo "âŒ è³‡æ–™æ”¶é›†å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/data_collector.log"
                exit 1
              fi
              echo "âœ… è³‡æ–™æ”¶é›†å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ CSV æª”æ¡ˆ: ls -la data/"
            continue-on-error: false
    
      finalize:
        runs-on: ubuntu-latest
        needs: data-collection
        steps:
          - name: Checkout Repository
            uses: actions/checkout@v3
            with:
              path: repo
          - name: Check Data Files
            working-directory: repo
            run: |
              echo "ðŸ” æª¢æŸ¥è³‡æ–™æª”æ¡ˆ"
              if [ -f "data/daily_0050.TW.csv" ]; then
                echo "âœ… data/daily_0050.TW.csv exists, size: $(du -h data/daily_0050.TW.csv | cut -f1)"
              else
                echo "âŒ data/daily_0050.TW.csv does not exist"
                exit 1
              fi
              if [ -f "logs/data_collector.log" ]; then
                echo "âœ… logs/data_collector.log exists, last modified: $(stat -c %y logs/data_collector.log)"
                echo "Latest log entry: $(tail -1 logs/data_collector.log)"
              else
                echo "âŒ logs/data_collector.log does not exist"
              fi
          - name: Upload Artifacts
            uses: actions/upload-artifact@v4
            with:
              name: data-collection-${{ github.run_id }}
              path: |
                repo/data/*.csv
                repo/logs/data_collector.log
              if-no-files-found: warn
              retention-days: 7
              compression-level: 6
              overwrite: false
