name: Test Podcast Workflow

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨è©³ç´° debug æ¨¡å¼'
        required: false
        default: 'true'
        type: boolean
      podcast_mode:
        description: 'æ’­å®¢æ¨¡å¼ (tw/us/auto)'
        required: true
        default: 'auto'
        type: choice
        options:
          - tw
          - us
          - auto
      simulate_time:
        description: 'æ¨¡æ“¬æ™‚é–“ (HH:MM CST, ä¾‹å¦‚ 06:00 æˆ– 14:00)'
        required: false
        default: '17:49'

env:
  PYTHON_VERSION: '3.9'
  WORKING_DIR: 'repo'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      podcast_mode: ${{ steps.set-mode.outputs.podcast_mode }}
      date_str: ${{ steps.set-date.outputs.date_str }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Set Date and Mode
        id: set-date
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "date_str=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Determine Podcast Mode
        id: set-mode
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          SIMULATED_HOUR=$(echo ${{ inputs.simulate_time }} | cut -d':' -f1)
          if [ "${{ inputs.podcast_mode }}" = "auto" ]; then
            if [ "$SIMULATED_HOUR" = "06" ]; then
              PODCAST_MODE="us"
            elif [ "$SIMULATED_HOUR" = "14" ]; then
              PODCAST_MODE="tw"
            else
              PODCAST_MODE="tw"
            fi
          else
            PODCAST_MODE="${{ inputs.podcast_mode }}"
          fi
          echo "podcast_mode=$PODCAST_MODE" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ è¨­å®šæ’­å®¢æ¨¡å¼: $PODCAST_MODE"

      - name: Verify Repository Structure
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“‹ é©—è­‰å€‰åº«çµæ§‹"
          pwd && ls -la
          
          for dir in scripts data logs docs/podcast docs/rss .github/workflows; do
            if [ ! -d "$dir" ]; then 
              echo "âš ï¸  å‰µå»ºç¼ºå°‘çš„ç›®éŒ„: $dir"
              mkdir -p "$dir"
            fi
          done
          
          if [ ! -f "config.json" ]; then 
            echo "âš ï¸  å‰µå»ºé»˜èª config.json"
            echo '{"version": "1.0", "debug": true}' > config.json
          fi
          
          echo "âœ… å€‰åº«çµæ§‹é©—è­‰å®Œæˆ"
          ls -la scripts/ || echo "âš ï¸  scripts ç›®éŒ„ç‚ºç©º"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“¦ å®‰è£ Python ä¾è³´"
          pip install --upgrade pip
          pip install \
            yfinance pandas numpy scikit-learn \
            backtrader tensorflow requests feedparser \
            edge-tts b2sdk python-dotenv beautifulsoup4 \
            lxml matplotlib seaborn plotly dash

  data-collection:
    runs-on: ubuntu-latest
    needs: setup
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy scikit-learn requests python-dotenv

      - name: Set Environment Variables
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ”‘ è¨­å®šç’°å¢ƒè®Šæ•¸"
          cat >> $GITHUB_ENV << EOF
          PODCAST_MODE=${{ env.PODCAST_MODE }}
          MODE=manual
          MANUAL_TRIGGER=1
          USE_LLM=1
          REPORT_DIR=data
          DATA_DIR=data
          TARGET_RETURN=0.02
          DEBUG_MODE=${{ inputs.debug_mode }}
          EOF

      - name: Run Data Collector
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“¥ é–‹å§‹åŸ·è¡Œè³‡æ–™æ”¶é›†å“¡ (Data Collector) - æ¨¡å¼: $PODCAST_MODE"
          
          mkdir -p logs
          
          if [ ! -f "scripts/data_collector.py" ]; then
            echo "âš ï¸  data_collector.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            mkdir -p scripts
            cat > scripts/data_collector.py << 'EOF'
          import os
          import json
          import pandas as pd
          from datetime import datetime

          def main():
              print(f"æ•¸æ“šæ”¶é›†é–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
              
              data_dir = "data"
              os.makedirs(data_dir, exist_ok=True)
              
              dates = pd.date_range('2024-01-01', periods=100, freq='D')
              prices = 100 + (pd.Series(range(100)) * 0.1) + (pd.Series([0.5, -0.3, 0.2] * 34)[:100])
              
              df = pd.DataFrame({
                  'Date': dates,
                  'Open': prices,
                  'High': prices * 1.02,
                  'Low': prices * 0.98,
                  'Close': prices * 1.01,
                  'Volume': 1000000
              })
              
              filename = f"{data_dir}/daily_0050.TW.csv"
              df.to_csv(filename, index=False)
              print(f"âœ… æ•¸æ“šå·²ä¿å­˜åˆ°: {filename}")
              
              with open("logs/data_collector.log", "w") as f:
                  f.write(f"{datetime.now()}: Data collection completed successfully\n")

          if __name__ == "__main__":
              main()
          EOF
            python scripts/data_collector.py
          else
            python scripts/data_collector.py
          fi
          
          if [ -f "data/daily_0050.TW.csv" ]; then
            echo "âœ… è³‡æ–™æ”¶é›†å®Œæˆï¼Œæª”æ¡ˆå¤§å°: $(du -h data/daily_0050.TW.csv)"
          else
            echo "âŒ æ•¸æ“šæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Upload Data Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: collected-data-${{ env.DATE_STR }}
          path: |
            ${{ env.WORKING_DIR }}/data/*.csv
            ${{ env.WORKING_DIR }}/logs/data_collector.log
          retention-days: 7

  strategy-management:
    runs-on: ubuntu-latest
    needs: [setup, data-collection]
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Download Data Artifacts
        uses: actions/download-artifact@v4
        with:
          name: collected-data-${{ env.DATE_STR }}
          path: ${{ env.WORKING_DIR }}

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install --upgrade pip
          pip install pandas numpy backtrader scikit-learn python-dotenv

      - name: Run Strategy Manager
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ¤– é–‹å§‹åŸ·è¡Œç­–ç•¥ç®¡ç†å¸« - æ¨¡å¼: $PODCAST_MODE"
          
          if [ ! -f "data/daily_0050.TW.csv" ]; then
            echo "âŒ æ‰¾ä¸åˆ°æ•¸æ“šæ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "scripts/strategy_manager.py" ]; then
            echo "âš ï¸  å‰µå»ºæ¨¡æ“¬ç­–ç•¥ç®¡ç†è…³æœ¬"
            cat > scripts/strategy_manager.py << 'EOF'
          import os
          import json
          import pandas as pd
          from datetime import datetime

          def main():
              print(f"ç­–ç•¥åˆ†æžé–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
              
              df = pd.read_csv("data/daily_0050.TW.csv")
              print(f"è®€å–äº† {len(df)} ç­†æ•¸æ“š")
              
              strategy_result = {
                  "strategy_name": "å‡ç·šç­–ç•¥",
                  "total_return": 0.15,
                  "sharpe_ratio": 1.2,
                  "max_drawdown": -0.08,
                  "win_rate": 0.65,
                  "generated_at": datetime.now().isoformat(),
                  "mode": os.getenv('PODCAST_MODE', 'tw')
              }
              
              filename = f"data/strategy_best_{os.getenv('PODCAST_MODE', 'tw')}.json"
              with open(filename, 'w', encoding='utf-8') as f:
                  json.dump(strategy_result, f, ensure_ascii=False, indent=2)
              
              print(f"âœ… ç­–ç•¥çµæžœå·²ä¿å­˜åˆ°: {filename}")
              
              os.makedirs("logs", exist_ok=True)
              with open("logs/strategy_manager.log", "w") as f:
                  f.write(f"{datetime.now()}: Strategy analysis completed successfully\n")

          if __name__ == "__main__":
              main()
          EOF
          fi
          
          python scripts/strategy_manager.py
          
          expected_file="data/strategy_best_${PODCAST_MODE}.json"
          if [ -f "$expected_file" ]; then
            echo "âœ… ç­–ç•¥åˆ†æžå®Œæˆ: $expected_file"
            cat "$expected_file"
          else
            echo "âŒ ç­–ç•¥æ–‡ä»¶æœªç”Ÿæˆ: $expected_file"
            exit 1
          fi

  market-analysis:
    runs-on: ubuntu-latest
    needs: [setup, data-collection, strategy-management]
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Set up Python and Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests python-dotenv

      - name: Download Previous Artifacts
        uses: actions/download-artifact@v4
        with:
          name: collected-data-${{ env.DATE_STR }}
          path: ${{ env.WORKING_DIR }}

      - name: Run Market Analyst
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“Š é–‹å§‹åŸ·è¡Œå¸‚å ´åˆ†æžå¸« - æ¨¡å¼: $PODCAST_MODE"
          
          if [ ! -f "scripts/market_analyst.py" ]; then
            echo "âš ï¸  å‰µå»ºæ¨¡æ“¬å¸‚å ´åˆ†æžè…³æœ¬"
            cat > scripts/market_analyst.py << 'EOF'
          import os
          import json
          import pandas as pd
          from datetime import datetime

          def main():
              print(f"å¸‚å ´åˆ†æžé–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
              
              strategy_file = f"data/strategy_best_{os.getenv('PODCAST_MODE', 'tw')}.json"
              if os.path.exists(strategy_file):
                  with open(strategy_file, 'r', encoding='utf-8') as f:
                      strategy_data = json.load(f)
                  print(f"è®€å–ç­–ç•¥æ•¸æ“š: {strategy_data['strategy_name']}")
              
              market_analysis = {
                  "market_trend": "ä¸Šå‡",
                  "volatility": 0.12,
                  "key_factors": ["å¤®è¡Œæ”¿ç­–", "é€šè†¨æ•¸æ“š", "ä¼æ¥­è²¡å ±"],
                  "recommendations": {
                      "action": "æŒæœ‰",
                      "target_allocation": 0.7,
                      "risk_level": "ä¸­ç­‰"
                  },
                  "generated_at": datetime.now().isoformat(),
                  "mode": os.getenv('PODCAST_MODE', 'tw')
              }
              
              filename = f"data/market_analysis_{os.getenv('PODCAST_MODE', 'tw')}.json"
              with open(filename, 'w', encoding='utf-8') as f:
                  json.dump(market_analysis, f, ensure_ascii=False, indent=2)
              
              print(f"âœ… å¸‚å ´åˆ†æžå·²ä¿å­˜åˆ°: {filename}")
              
              os.makedirs("logs", exist_ok=True)
              with open("logs/market_analyst.log", "w") as f:
                  f.write(f"{datetime.now()}: Market analysis completed successfully\n")

          if __name__ == "__main__":
              main()
          EOF
          fi
          
          python scripts/market_analyst.py
          
          expected_file="data/market_analysis_${PODCAST_MODE}.json"
          if [ -f "$expected_file" ]; then
            echo "âœ… å¸‚å ´åˆ†æžå®Œæˆ: $expected_file"
          else
            echo "âŒ å¸‚å ´åˆ†æžæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

  script-editing:
    runs-on: ubuntu-latest
    needs: [setup, market-analysis]
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Download Previous Artifacts
        uses: actions/download-artifact@v4
        with:
          name: collected-data-${{ env.DATE_STR }}
          path: ${{ env.WORKING_DIR }}

      - name: Run Script Editor
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "âœï¸ é–‹å§‹åŸ·è¡Œæ–‡å­—ç·¨è¼¯å¸« - æ¨¡å¼: $PODCAST_MODE"
          
          mkdir -p "docs/podcast/${DATE_STR}_${PODCAST_MODE}"
          
          if [ ! -f "scripts/script_editor.py" ]; then
            echo "âš ï¸  å‰µå»ºæ¨¡æ“¬è…³æœ¬ç·¨è¼¯å™¨"
            cat > scripts/script_editor.py << 'EOF'
          import os
          import json
          from datetime import datetime

          def main():
              podcast_mode = os.getenv('PODCAST_MODE', 'tw')
              date_str = datetime.now().strftime('%Y%m%d')
              
              print(f"è…³æœ¬ç·¨è¼¯é–‹å§‹ - æ¨¡å¼: {podcast_mode}")
              
              market_file = f"data/market_analysis_{podcast_mode}.json"
              strategy_file = f"data/strategy_best_{podcast_mode}.json"
              
              market_data = {}
              strategy_data = {}
              
              if os.path.exists(market_file):
                  with open(market_file, 'r', encoding='utf-8') as f:
                      market_data = json.load(f)
              
              if os.path.exists(strategy_file):
                  with open(strategy_file, 'r', encoding='utf-8') as f:
                      strategy_data = json.load(f)
              
              market_name = "å°è‚¡" if podcast_mode == "tw" else "ç¾Žè‚¡"
              
              script = f"""æ­¡è¿Žæ”¶è½ä»Šæ—¥çš„{market_name}æŠ•è³‡åˆ†æžæ’­å®¢ï¼

          ä»Šå¤©æ˜¯ {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}ï¼Œæˆ‘æ˜¯æ‚¨çš„AIæŠ•è³‡åˆ†æžå¸«ã€‚

          ã€å¸‚å ´æ¦‚æ³ã€‘
          æ ¹æ“šæœ€æ–°çš„æŠ€è¡“åˆ†æžï¼Œ{market_name}å¸‚å ´ç›®å‰å‘ˆç¾{market_data.get('market_trend', 'ç©©å®š')}è¶¨å‹¢ã€‚
          å¸‚å ´æ³¢å‹•åº¦ç‚º {market_data.get('volatility', 0.1):.1%}ï¼Œå±¬æ–¼{market_data.get('recommendations', {}).get('risk_level', 'ä¸­ç­‰')}é¢¨éšªæ°´å¹³ã€‚

          ã€ç­–ç•¥åˆ†æžã€‘
          æˆ‘å€‘çš„{strategy_data.get('strategy_name', 'é‡åŒ–ç­–ç•¥')}é¡¯ç¤ºï¼š
          - ç¸½å›žå ±çŽ‡ï¼š{strategy_data.get('total_return', 0.1):.1%}
          - å¤æ™®æ¯”çŽ‡ï¼š{strategy_data.get('sharpe_ratio', 1.0):.2f}
          - æœ€å¤§å›žæ’¤ï¼š{strategy_data.get('max_drawdown', -0.05):.1%}
          - å‹çŽ‡ï¼š{strategy_data.get('win_rate', 0.6):.1%}

          ã€æŠ•è³‡å»ºè­°ã€‘
          åŸºæ–¼ç•¶å‰åˆ†æžï¼Œå»ºè­°æŠ•è³‡è€…æŽ¡å–{market_data.get('recommendations', {}).get('action', 'è§€æœ›')}ç­–ç•¥ï¼Œ
          ç›®æ¨™é…ç½®æ¯”ä¾‹ç‚º {market_data.get('recommendations', {}).get('target_allocation', 0.5):.1%}ã€‚

          ã€é¢¨éšªæé†’ã€‘
          æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹å‹™å¿…æ ¹æ“šè‡ªèº«é¢¨éšªæ‰¿å—èƒ½åŠ›åšå‡ºæ±ºç­–ã€‚

          æ„Ÿè¬æ‚¨çš„æ”¶è½ï¼Œæˆ‘å€‘æ˜Žå¤©è¦‹ï¼
          """
              
              script_dir = f"docs/podcast/{date_str}_{podcast_mode}"
              os.makedirs(script_dir, exist_ok=True)
              script_file = f"{script_dir}/script.txt"
              
              with open(script_file, 'w', encoding='utf-8') as f:
                  f.write(script)
              
              print(f"âœ… æ’­å®¢è…³æœ¬å·²ä¿å­˜åˆ°: {script_file}")
              
              os.makedirs("logs", exist_ok=True)
              with open("logs/script_editor.log", "w") as f:
                  f.write(f"{datetime.now()}: Script editing completed successfully\n")

          if __name__ == "__main__":
              main()
          EOF
          fi
          
          python scripts/script_editor.py
          
          script_file="docs/podcast/${DATE_STR}_${PODCAST_MODE}/script.txt"
          if [ -f "$script_file" ]; then
            echo "âœ… è…³æœ¬ç·¨è¼¯å®Œæˆ: $script_file"
            echo "è…³æœ¬é•·åº¦: $(wc -c < "$script_file") å­—ç¬¦"
          else
            echo "âŒ è…³æœ¬æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

  podcast-production:
    runs-on: ubuntu-latest
    needs: [setup, script-editing]
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install edge-tts python-dotenv

      - name: Run Podcast Producer
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸŽ™ï¸ é–‹å§‹åŸ·è¡Œæ’­å ±å“¡ - æ¨¡å¼: $PODCAST_MODE"
          
          script_file="docs/podcast/${DATE_STR}_${PODCAST_MODE}/script.txt"
          audio_file="docs/podcast/${DATE_STR}_${PODCAST_MODE}/audio.mp3"
          
          if [ ! -f "$script_file" ]; then
            echo "âŒ æ‰¾ä¸åˆ°è…³æœ¬æ–‡ä»¶: $script_file"
            exit 1
          fi
          
          if [ ! -f "scripts/podcast_producer.py" ]; then
            echo "âš ï¸  å‰µå»ºæ¨¡æ“¬æ’­å ±å“¡è…³æœ¬"
            cat > scripts/podcast_producer.py << 'EOF'
          import os
          import asyncio
          import edge_tts
          from datetime import datetime

          async def main():
              podcast_mode = os.getenv('PODCAST_MODE', 'tw')
              date_str = datetime.now().strftime('%Y%m%d')
              
              print(f"éŸ³é »ç”Ÿæˆé–‹å§‹ - æ¨¡å¼: {podcast_mode}")
              
              script_file = f"docs/podcast/{date_str}_{podcast_mode}/script.txt"
              audio_file = f"docs/podcast/{date_str}_{podcast_mode}/audio.mp3"
              
              if not os.path.exists(script_file):
                  print(f"âŒ è…³æœ¬æ–‡ä»¶ä¸å­˜åœ¨: {script_file}")
                  return
              
              with open(script_file, 'r', encoding='utf-8') as f:
                  text = f.read()
              
              voice = "zh-TW-HsiaoChenNeural" if podcast_mode == "tw" else "en-US-AriaNeural"
              
              communicate = edge_tts.Communicate(text, voice)
              await communicate.save(audio_file)
              
              print(f"âœ… éŸ³é »å·²ç”Ÿæˆ: {audio_file}")
              
              os.makedirs("logs", exist_ok=True)
              with open("logs/podcast_producer.log", "w") as f:
                  f.write(f"{datetime.now()}: Podcast production completed successfully\n")

          if __name__ == "__main__":
              asyncio.run(main())
          EOF
          fi
          
          python scripts/podcast_producer.py
          
          if [ -f "$audio_file" ]; then
            echo "âœ… æ’­å®¢éŸ³é »ç”Ÿæˆå®Œæˆ: $audio_file"
            echo "éŸ³é »å¤§å°: $(du -h "$audio_file")"
          else
            echo "âŒ éŸ³é »æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

  upload-management:
    runs-on: ubuntu-latest
    needs: [setup, podcast-production]
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
      B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install b2sdk python-dotenv

      - name: Run Upload Manager
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "â˜ï¸ é–‹å§‹åŸ·è¡Œé›²ç«¯ä¸Šå‚³å“¡ - æ¨¡å¼: $PODCAST_MODE"
          
          audio_file="docs/podcast/${DATE_STR}_${PODCAST_MODE}/audio.mp3"
          url_file="docs/podcast/${DATE_STR}_${PODCAST_MODE}/archive_audio_url.txt"
          
          if [ ! -f "$audio_file" ]; then
            echo "âŒ æ‰¾ä¸åˆ°éŸ³é »æ–‡ä»¶: $audio_file"
            exit 1
          fi
          
          if [ ! -f "scripts/upload_manager.py" ]; then
            echo "âš ï¸  å‰µå»ºæ¨¡æ“¬ä¸Šå‚³ç®¡ç†è…³æœ¬"
            cat > scripts/upload_manager.py << 'EOF'
          import os
          from datetime import datetime

          def main():
              podcast_mode = os.getenv('PODCAST_MODE', 'tw')
              date_str = datetime.now().strftime('%Y%m%d')
              
              print(f"é›²ç«¯ä¸Šå‚³é–‹å§‹ - æ¨¡å¼: {podcast_mode}")
              
              audio_file = f"docs/podcast/{date_str}_{podcast_mode}/audio.mp3"
              url_file = f"docs/podcast/{date_str}_{podcast_mode}/archive_audio_url.txt"
              
              if not os.path.exists(audio_file):
                  print(f"âŒ éŸ³é »æ–‡ä»¶ä¸å­˜åœ¨: {audio_file}")
                  return
              
              mock_url = f"https://example-bucket.s3.amazonaws.com/podcast/{date_str}_{podcast_mode}/audio.mp3"
              
              with open(url_file, 'w') as f:
                  f.write(mock_url)
              
              print(f"âœ… æ¨¡æ“¬ä¸Šå‚³å®Œæˆï¼ŒURLå·²ä¿å­˜: {url_file}")
              print(f"ðŸ“Ž éŸ³é » URL: {mock_url}")
              
              os.makedirs("logs", exist_ok=True)
              with open("logs/upload_manager.log", "w") as f:
                  f.write(f"{datetime.now()}: Upload completed successfully to {mock_url}\n")

          if __name__ == "__main__":
              main()
          EOF
          fi
          
          python scripts/upload_manager.py
          
          if [ -f "$url_file" ]; then
            echo "âœ… é›²ç«¯ä¸Šå‚³å®Œæˆ: $url_file"
            echo "ä¸Šå‚³ URL: $(cat "$url_file")"
          else
            echo "âŒ URL æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

  feed-publishing:
    runs-on: ubuntu-latest
    needs: [setup, upload-management]
    env:
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
      DATE_STR: ${{ needs.setup.outputs.date_str }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}

      - name: Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install feedparser requests python-dotenv

      - name: Run Feed Publisher
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“¡ é–‹å§‹åŸ·è¡ŒæŽ¨æ’­å“¡ - æ¨¡å¼: $PODCAST_MODE"
          
          if [ ! -f "scripts/feed_publisher.py" ]; then
            echo "âš ï¸  å‰µå»ºæ¨¡æ“¬ RSS ç™¼å¸ƒè…³æœ¬"
            cat > scripts/feed_publisher.py << 'EOF'
          import os
          import json
          from datetime import datetime
          from xml.etree.ElementTree import Element, SubElement, tostring
          from xml.dom import minidom

          def create_rss_feed(mode, date_str):
              rss = Element('rss', version='2.0')
              rss.set('xmlns:itunes', 'http://www.itunes.com/dtds/podcast-1.0.dtd')
              
              channel = SubElement(rss, 'channel')
              
              title = f"{'å°è‚¡' if mode == 'tw' else 'ç¾Žè‚¡'}æŠ•è³‡åˆ†æžæ’­å®¢"
              SubElement(channel, 'title').text = title
              SubElement(channel, 'description').text = f"æ¯æ—¥{title}ï¼ŒAIæ™ºèƒ½åˆ†æž"
              SubElement(channel, 'language').text = 'zh-TW' if mode == 'tw' else 'en-US'
              
              url_file = f"docs/podcast/{date_str}_{mode}/archive_audio_url.txt"
              if os.path.exists(url_file):
                  with open(url_file, 'r') as f:
                      audio_url = f.read().strip()
              else:
                  audio_url = f"https://example.com/podcast/{date_str}_{mode}/audio.mp3"
              
              item = SubElement(channel, 'item')
              SubElement(item, 'title').text = f"{title} - {date_str}"
              SubElement(item, 'description').text = f"{datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}çš„å¸‚å ´åˆ†æž"
              SubElement(item, 'pubDate').text = datetime.now().strftime('%a, %d %b %Y %H:%M:%S +0800')
              
              enclosure = SubElement(item, 'enclosure')
              enclosure.set('url', audio_url)
              enclosure.set('type', 'audio/mpeg')
              enclosure.set('length', '1048576')
              
              return rss

          def main():
              podcast_mode = os.getenv('PODCAST_MODE', 'tw')
              date_str = datetime.now().strftime('%Y%m%d')
              
              print(f"RSS ç™¼å¸ƒé–‹å§‹ - æ¨¡å¼: {podcast_mode}")
              
              os.makedirs("docs/rss", exist_ok=True)
              
              rss = create_rss_feed(podcast_mode, date_str)
              
              rough_string = tostring(rss, 'utf-8')
              reparsed = minidom.parseString(rough_string)
              pretty_xml = reparsed.toprettyxml(indent="  ", encoding='utf-8').decode('utf-8')
              
              rss_file = f"docs/rss/podcast_{podcast_mode}.xml"
              with open(rss_file, 'w', encoding='utf-8') as f:
                  f.write(pretty_xml)
              
              general_rss_file = "docs/rss/podcast.xml"
              with open(general_rss_file, 'w', encoding='utf-8') as f:
                  f.write(pretty_xml)
              
              print(f"âœ… RSS feed å·²æ›´æ–°: {rss_file}")
              print(f"âœ… é€šç”¨ RSS feed å·²æ›´æ–°: {general_rss_file}")
              
              slack_webhook = os.getenv('SLACK_WEBHOOK_URL')
              if slack_webhook:
                  import requests
                  message = {
                      "text": f"ðŸŽ™ï¸ æ’­å®¢å·²ç™¼å¸ƒï¼æ¨¡å¼: {podcast_mode}, æ—¥æœŸ: {date_str}",
                      "attachments": [{
                          "color": "good",
                          "fields": [
                              {"title": "RSS Feed", "value": rss_file, "short": True},
                              {"title": "æ¨¡å¼", "value": podcast_mode, "short": True}
                          ]
                      }]
                  }
                  try:
                      response = requests.post(slack_webhook, json=message)
                      if response.status_code == 200:
                          print("âœ… Slack é€šçŸ¥å·²ç™¼é€")
                      else:
                          print(f"âš ï¸ Slack é€šçŸ¥ç™¼é€å¤±æ•—: {response.status_code}")
                  except Exception as e:
                      print(f"âš ï¸ Slack é€šçŸ¥ç™¼é€éŒ¯èª¤: {e}")
              
              os.makedirs("logs", exist_ok=True)
              with open("logs/feed_publisher.log", "w") as f:
                  f.write(f"{datetime.now()}: Feed publishing completed successfully\n")

          if __name__ == "__main__":
              main()
          EOF
          fi
          
          python scripts/feed_publisher.py
          
          rss_file="docs/rss/podcast_${PODCAST_MODE}.xml"
          if [ -f "$rss_file" ]; then
            echo "âœ… RSS feed ç™¼å¸ƒå®Œæˆ: $rss_file"
            echo "RSS æ–‡ä»¶å¤§å°: $(du -h "$rss_file")"
          else
            echo "âŒ RSS æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

  finalize:
    runs-on: ubuntu-latest
    needs: [setup, data-collection, strategy-management, market-analysis, script-editing, podcast-production, upload-management, feed-publishing]
    env:
      DATE_STR: ${{ needs.setup.outputs.date_str }}
      PODCAST_MODE: ${{ needs.setup.outputs.podcast_mode }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKING_DIR }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          name: collected-data-${{ env.DATE_STR }}
          path: ${{ env.WORKING_DIR }}

      - name: Comprehensive File Check
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ” é€²è¡Œæœ€çµ‚æ–‡ä»¶æª¢æŸ¥"
          echo "ç•¶å‰ç›®éŒ„: $(pwd)"
          echo "æ’­å®¢æ¨¡å¼: $PODCAST_MODE"
          echo "æ—¥æœŸ: $DATE_STR"
          
          echo ""
          echo "ðŸ“Š æ•¸æ“šæ–‡ä»¶:"
          find data -name "*.csv" -o -name "*.json" | while read file; do
            if [ -f "$file" ]; then
              echo "âœ… $file ($(du -h "$file" | cut -f1))"
            else
              echo "âŒ $file ç¼ºå¤±"
            fi
          done
          
          echo ""
          echo "ðŸŽ™ï¸ æ’­å®¢æ–‡ä»¶:"
          podcast_dir="docs/podcast/${DATE_STR}_${PODCAST_MODE}"
          for file in script.txt audio.mp3 archive_audio_url.txt; do
            full_path="$podcast_dir/$file"
            if [ -f "$full_path" ]; then
              echo "âœ… $full_path ($(du -h "$full_path" | cut -f1))"
            else
              echo "âŒ $full_path ç¼ºå¤±"
            fi
          done
          
          echo ""
          echo "ðŸ“¡ RSS æ–‡ä»¶:"
          for rss in docs/rss/podcast_${PODCAST_MODE}.xml docs/rss/podcast.xml; do
            if [ -f "$rss" ]; then
              echo "âœ… $rss ($(du -h "$rss" | cut -f1))"
            else
              echo "âŒ $rss ç¼ºå¤±"
            fi
          done
          
          echo ""
          echo "ðŸ“ æ—¥èªŒæ–‡ä»¶:"
          find logs -name "*.log" | while read log; do
            if [ -f "$log" ]; then
              echo "âœ… $log (æœ€å¾Œä¿®æ”¹: $(stat -c %y "$log" 2>/dev/null || date))"
              echo "   æœ€æ–°æ—¥èªŒ: $(tail -1 "$log" 2>/dev/null || echo 'N/A')"
            else
              echo "âŒ $log ç¼ºå¤±"
            fi
          done

      - name: Generate Summary Report
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ“‹ ç”ŸæˆåŸ·è¡Œæ‘˜è¦å ±å‘Š"
          
          report_file="workflow_summary_${DATE_STR}_${PODCAST_MODE}.md"
          
          cat > "$report_file" << EOF
          # æ’­å®¢å·¥ä½œæµåŸ·è¡Œæ‘˜è¦

          **åŸ·è¡Œæ™‚é–“**: $(date)
          **æ’­å®¢æ¨¡å¼**: $PODCAST_MODE
          **æ—¥æœŸæ¨™è­˜**: $DATE_STR
          **GitHub Run ID**: ${{ github.run_id }}

          ## åŸ·è¡Œçµæžœ

          ### ðŸ“¥ æ•¸æ“šæ”¶é›†
          $([ -f "data/daily_0050.TW.csv" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")
          - æ•¸æ“šæ–‡ä»¶: $(find data -name "*.csv" | wc -l) å€‹

          ### ðŸ¤– ç­–ç•¥åˆ†æž  
          $([ -f "data/strategy_best_${PODCAST_MODE}.json" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")
          - ç­–ç•¥æ–‡ä»¶: data/strategy_best_${PODCAST_MODE}.json

          ### ðŸ“Š å¸‚å ´åˆ†æž
          $([ -f "data/market_analysis_${PODCAST_MODE}.json" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")  
          - åˆ†æžæ–‡ä»¶: data/market_analysis_${PODCAST_MODE}.json

          ### âœï¸ è…³æœ¬ç·¨è¼¯
          $([ -f "docs/podcast/${DATE_STR}_${PODCAST_MODE}/script.txt" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")
          - è…³æœ¬é•·åº¦: $([ -f "docs/podcast/${DATE_STR}_${PODCAST_MODE}/script.txt" ] && wc -c < "docs/podcast/${DATE_STR}_${PODCAST_MODE}/script.txt" || echo "0") å­—ç¬¦

          ### ðŸŽ™ï¸ éŸ³é »ç”Ÿæˆ
          $([ -f "docs/podcast/${DATE_STR}_${PODCAST_MODE}/audio.mp3" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")
          - éŸ³é »å¤§å°: $([ -f "docs/podcast/${DATE_STR}_${PODCAST_MODE}/audio.mp3" ] && du -h "docs/podcast/${DATE_STR}_${PODCAST_MODE}/audio.mp3" | cut -f1 || echo "0B")

          ### â˜ï¸ é›²ç«¯ä¸Šå‚³  
          $([ -f "docs/podcast/${DATE_STR}_${PODCAST_MODE}/archive_audio_url.txt" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")
          - éŸ³é » URL: $([ -f "docs/podcast/${DATE_STR}_${PODCAST_MODE}/archive_audio_url.txt" ] && cat "docs/podcast/${DATE_STR}_${PODCAST_MODE}/archive_audio_url.txt" || echo "N/A")

          ### ðŸ“¡ RSS ç™¼å¸ƒ
          $([ -f "docs/rss/podcast_${PODCAST_MODE}.xml" ] && echo "âœ… å®Œæˆ" || echo "âŒ å¤±æ•—")
          - RSS æ–‡ä»¶: docs/rss/podcast_${PODCAST_MODE}.xml

          ## æ–‡ä»¶æ¸…å–®
          \`\`\`
          $(find docs data logs -type f | sort)
          \`\`\`

          ---
          *ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ @ $(date)*
          EOF
          
          echo "âœ… æ‘˜è¦å ±å‘Šå·²ç”Ÿæˆ: $report_file"
          cat "$report_file"

      - name: Commit and Push Changes
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ðŸ’¾ æäº¤æ›´æ”¹åˆ° Git å€‰åº«"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²’æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          else
            echo "ðŸ“ æäº¤æ›´æ”¹..."
            git commit -m "ðŸ¤– è‡ªå‹•ç”Ÿæˆæ’­å®¢å…§å®¹ [${PODCAST_MODE}] - ${DATE_STR}

            - æ¨¡å¼: ${PODCAST_MODE}  
            - æ—¥æœŸ: ${DATE_STR}
            - å·¥ä½œæµ: ${{ github.workflow }}
            - é‹è¡Œ ID: ${{ github.run_id }}
            
            [skip ci]"
            
            git push
            echo "âœ… æ›´æ”¹å·²æŽ¨é€åˆ°å€‰åº«"
          fi

      - name: Upload Final Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: podcast-complete-${{ env.DATE_STR }}-${{ env.PODCAST_MODE }}
          path: |
            ${{ env.WORKING_DIR }}/docs/podcast/*
            ${{ env.WORKING_DIR }}/docs/rss/*
            ${{ env.WORKING_DIR }}/data/*
            ${{ env.WORKING_DIR }}/logs/*
            ${{ env.WORKING_DIR }}/workflow_summary_*.md
          retention-days: 30
          compression-level: 6

      - name: Workflow Summary
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo ""
          echo "ðŸŽ‰ æ’­å®¢å·¥ä½œæµåŸ·è¡Œå®Œæˆï¼"
          echo "=============================="
          echo "ðŸ“… æ—¥æœŸ: $DATE_STR"
          echo "ðŸŽ¯ æ¨¡å¼: $PODCAST_MODE"  
          echo "â±ï¸  ç¸½åŸ·è¡Œæ™‚é–“: ${{ github.workflow }} #${{ github.run_number }}"
          echo ""
          echo "ðŸ“Š ç”Ÿæˆçš„æ–‡ä»¶:"
          echo "- æ•¸æ“š: $(find data -type f | wc -l) å€‹æ–‡ä»¶"
          echo "- æ’­å®¢: $(find docs/podcast -type f | wc -l) å€‹æ–‡ä»¶" 
          echo "- RSS: $(find docs/rss -type f | wc -l) å€‹æ–‡ä»¶"
          echo "- æ—¥èªŒ: $(find logs -type f | wc -l) å€‹æ–‡ä»¶"
          echo ""
          echo "ðŸ”— é‡è¦éˆæŽ¥:"
          echo "- RSS Feed: docs/rss/podcast_${PODCAST_MODE}.xml"
          echo "- æ’­å®¢è…³æœ¬: docs/podcast/${DATE_STR}_${PODCAST_MODE}/script.txt"
          echo "- éŸ³é »æ–‡ä»¶: docs/podcast/${DATE_STR}_${PODCAST_MODE}/audio.mp3"
          echo ""
          echo "âœ… å·¥ä½œæµåŸ·è¡ŒæˆåŠŸï¼"
