name: Test Podcast Workflow

# æ‰‹å‹•è§¸ç™¼ä»¥ä¾¿æ¸¬è©¦ï¼Œæ–°å¢æ¨¡æ“¬æ¨¡å¼é¸é …
on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨è©³ç´° debug æ¨¡å¼'
        required: false
        default: 'true'
        type: boolean
      podcast_mode:
        description: 'æ’­å®¢æ¨¡å¼ (tw/us/auto)'
        required: true
        default: 'auto'
        type: choice
        options:
          - tw
          - us
          - auto
      simulate_time:
        description: 'æ¨¡æ“¬æ™‚é–“ (HH:MM CST, ä¾‹å¦‚ 06:00 æˆ– 14:00)'
        required: false
        default: '18:26'  # ç•¶å‰æ™‚é–“ç´„ 18:26 CST

# å®šç¾©ä½œæ¥­ç’°å¢ƒ
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo  # ç›´æ¥ä½¿ç”¨ repo ä½œç‚ºå–®ä¸€ç›®éŒ„
      - name: Verify Repository Structure
        working-directory: repo
        run: |
          echo "ğŸ“‹ é©—è­‰å€‰åº«çµæ§‹"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la  # åˆ—å‡ºæ‰€æœ‰æª”æ¡ˆå’Œç›®éŒ„
          for dir in scripts data logs docs/podcast docs/rss .github/workflows; do
            if [ ! -d "$dir" ]; then 
              echo "âš ï¸  å‰µå»ºç¼ºå°‘çš„ç›®éŒ„: $dir"
              mkdir -p "$dir"
            fi
          done
          if [ ! -f "config.json" ]; then 
            echo "âš ï¸  å‰µå»ºé»˜èª config.json"
            echo '{"version": "1.0", "debug": true}' > config.json
          fi
          ls -la scripts/ || echo "âš ï¸  scripts ç›®éŒ„ç‚ºç©º"
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Dependencies
        working-directory: repo
        run: |
          echo "ğŸ“¦ å®‰è£ä¾è³´"
          pip install --upgrade pip
          pip install yfinance pandas backtrader numpy scikit-learn tensorflow requests feedparser edge-tts b2sdk
      - name: Set Environment Variables
        working-directory: repo
        run: |
          echo "ğŸ”‘ è¨­å®šç’°å¢ƒè®Šæ•¸"
          SIMULATED_HOUR=$(echo ${{ inputs.simulate_time }} | cut -d':' -f1)
          if [ "$SIMULATED_HOUR" = "06" ]; then
            echo "PODCAST_MODE=us" >> $GITHUB_ENV
          elif [ "$SIMULATED_HOUR" = "14" ]; then
            echo "PODCAST_MODE=tw" >> $GITHUB_ENV
          else
            echo "PODCAST_MODE=${{ github.event.inputs.podcast_mode || 'auto' }}" >> $GITHUB_ENV
          fi
          echo "MODE=manual" >> $GITHUB_ENV
          echo "MANUAL_TRIGGER=1" >> $GITHUB_ENV
          echo "USE_LLM=1" >> $GITHUB_ENV
          echo "REPORT_DIR=data" >> $GITHUB_ENV
          echo "DATA_DIR=data" >> $GITHUB_ENV
          echo "TARGET_RETURN=0.02" >> $GITHUB_ENV
          echo "GROK_API_KEY=${{ secrets.GROK_API_KEY }}" >> $GITHUB_ENV
          echo "B2_KEY_ID=${{ secrets.B2_KEY_ID }}" >> $GITHUB_ENV
          echo "B2_APPLICATION_KEY=${{ secrets.B2_APPLICATION_KEY }}" >> $GITHUB_ENV
          echo "B2_BUCKET_NAME=${{ secrets.B2_BUCKET_NAME }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV
          echo "DEBUG_MODE=${{ inputs.debug_mode }}" >> $GITHUB_ENV

  data-collection:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Data Collector
        working-directory: repo
        run: |
          echo "ğŸ“¥ é–‹å§‹åŸ·è¡Œè³‡æ–™æ”¶é›†å“¡ (Data Collector) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p logs
          if [ ! -f "scripts/data_collector.py" ]; then
            echo "âš ï¸  data_collector.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/data_collector.py << 'EOF'
import os
import pandas as pd
from datetime import datetime

def main():
    print(f"æ•¸æ“šæ”¶é›†é–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    data_dir = "data"
    os.makedirs(data_dir, exist_ok=True)
    dates = pd.date_range('2024-01-01', periods=100, freq='D')
    prices = 100 + (pd.Series(range(100)) * 0.1)
    df = pd.DataFrame({'Date': dates, 'Close': prices})
    filename = f"{data_dir}/daily_0050.TW.csv"
    df.to_csv(filename, index=False)
    print(f"âœ… æ•¸æ“šå·²ä¿å­˜åˆ°: {filename}")
    with open("logs/data_collector.log", "w") as f:
        f.write(f"{datetime.now()}: Data collection completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/data_collector.py
          if [ $? -ne 0 ]; then
            echo "âŒ è³‡æ–™æ”¶é›†å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/data_collector.log"
            exit 1
          fi
          echo "âœ… è³‡æ–™æ”¶é›†å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ CSV æª”æ¡ˆ: ls -la data/"
        continue-on-error: false

  strategy-management:
    runs-on: ubuntu-latest
    needs: data-collection
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Strategy Manager
        working-directory: repo
        run: |
          echo "ğŸ¤– é–‹å§‹åŸ·è¡Œç­–ç•¥ç®¡ç†å¸« (Strategy Manager) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p logs
          if [ ! -f "scripts/strategy_manager.py" ]; then
            echo "âš ï¸  strategy_manager.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/strategy_manager.py << 'EOF'
import os
import json
import pandas as pd
from datetime import datetime

def main():
    print(f"ç­–ç•¥åˆ†æé–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    df = pd.read_csv("data/daily_0050.TW.csv")
    strategy = {"name": "å‡ç·šç­–ç•¥", "win_rate": 0.65}
    filename = f"data/strategy_best_{os.getenv('PODCAST_MODE', 'tw')}.json"
    with open(filename, 'w') as f:
        json.dump(strategy, f)
    print(f"âœ… ç­–ç•¥çµæœå·²ä¿å­˜åˆ°: {filename}")
    with open("logs/strategy_manager.log", "w") as f:
        f.write(f"{datetime.now()}: Strategy analysis completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/strategy_manager.py
          if [ $? -ne 0 ]; then
            echo "âŒ ç­–ç•¥ç®¡ç†å¸«åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/strategy_manager.log"
            exit 1
          fi
          echo "âœ… ç­–ç•¥ç®¡ç†å¸«åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ strategy_best_*.json: ls -la data/strategy_best_*.json"
        continue-on-error: false

  market-analysis:
    runs-on: ubuntu-latest
    needs: strategy-management
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Market Analyst
        working-directory: repo
        run: |
          echo "ğŸ“Š é–‹å§‹åŸ·è¡Œå¸‚å ´åˆ†æå¸« (Market Analyst) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p logs
          if [ ! -f "scripts/market_analyst.py" ]; then
            echo "âš ï¸  market_analyst.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/market_analyst.py << 'EOF'
import os
import json
from datetime import datetime

def main():
    print(f"å¸‚å ´åˆ†æé–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    analysis = {"trend": "ä¸Šå‡", "volatility": 0.1}
    filename = f"data/market_analysis_{os.getenv('PODCAST_MODE', 'tw')}.json"
    with open(filename, 'w') as f:
        json.dump(analysis, f)
    print(f"âœ… å¸‚å ´åˆ†æå·²ä¿å­˜åˆ°: {filename}")
    with open("logs/market_analyst.log", "w") as f:
        f.write(f"{datetime.now()}: Market analysis completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/market_analyst.py
          if [ $? -ne 0 ]; then
            echo "âŒ å¸‚å ´åˆ†æå¸«åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/market_analyst.log"
            exit 1
          fi
          echo "âœ… å¸‚å ´åˆ†æå¸«åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ data/ ç›®éŒ„ä¸‹çš„ market_analysis_*.json: ls -la data/market_analysis_*.json"
        continue-on-error: false

  script-editing:
    runs-on: ubuntu-latest
    needs: market-analysis
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Script Editor
        working-directory: repo
        run: |
          echo "âœï¸ é–‹å§‹åŸ·è¡Œæ–‡å­—ç·¨è¼¯å¸« (Script Editor) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p "docs/podcast/$(date +%Y%m%d)_${PODCAST_MODE}"
          if [ ! -f "scripts/script_editor.py" ]; then
            echo "âš ï¸  script_editor.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/script_editor.py << 'EOF'
import os
from datetime import datetime

def main():
    print(f"è…³æœ¬ç·¨è¼¯é–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    date_str = datetime.now().strftime('%Y%m%d')
    script = f"é€™æ˜¯æ¨¡æ“¬æ’­å®¢è…³æœ¬ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}"
    with open(f"docs/podcast/{date_str}_{os.getenv('PODCAST_MODE', 'tw')}/script.txt", 'w') as f:
        f.write(script)
    print(f"âœ… è…³æœ¬å·²ä¿å­˜")
    with open("logs/script_editor.log", "w") as f:
        f.write(f"{datetime.now()}: Script editing completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/script_editor.py
          if [ $? -ne 0 ]; then
            echo "âŒ æ–‡å­—ç·¨è¼¯å¸«åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/script_editor.log"
            exit 1
          fi
          echo "âœ… æ–‡å­—ç·¨è¼¯å¸«åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/podcast/YYYYMMDD_*/script.txt: ls -la docs/podcast/$(date +%Y%m%d)_*/script.txt"
        continue-on-error: false
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

  podcast-production:
    runs-on: ubuntu-latest
    needs: script-editing
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Podcast Producer
        working-directory: repo
        run: |
          echo "ğŸ™ï¸ é–‹å§‹åŸ·è¡Œæ’­å ±å“¡ (Podcast Producer) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p "docs/podcast/$(date +%Y%m%d)_${PODCAST_MODE}"
          if [ ! -f "scripts/podcast_producer.py" ]; then
            echo "âš ï¸  podcast_producer.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/podcast_producer.py << 'EOF'
import os
from datetime import datetime

def main():
    print(f"éŸ³é »ç”Ÿæˆé–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    date_str = datetime.now().strftime('%Y%m%d')
    with open(f"docs/podcast/{date_str}_{os.getenv('PODCAST_MODE', 'tw')}/audio.mp3", 'w') as f:
        f.write("æ¨¡æ“¬éŸ³é »æ•¸æ“š")
    print(f"âœ… éŸ³é »å·²ç”Ÿæˆ")
    with open("logs/podcast_producer.log", "w") as f:
        f.write(f"{datetime.now()}: Podcast production completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/podcast_producer.py
          if [ $? -ne 0 ]; then
            echo "âŒ æ’­å ±å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/podcast_producer.log"
            exit 1
          fi
          echo "âœ… æ’­å ±å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/podcast/YYYYMMDD_*/audio.mp3: ls -la docs/podcast/$(date +%Y%m%d)_*/audio.mp3"
        continue-on-error: false

  upload-management:
    runs-on: ubuntu-latest
    needs: podcast-production
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Upload Manager
        working-directory: repo
        run: |
          echo "â˜ï¸ é–‹å§‹åŸ·è¡Œé›²ç«¯ä¸Šå‚³å“¡ (Upload Manager) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p "docs/podcast/$(date +%Y%m%d)_${PODCAST_MODE}"
          if [ ! -f "scripts/upload_manager.py" ]; then
            echo "âš ï¸  upload_manager.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/upload_manager.py << 'EOF'
import os
from datetime import datetime

def main():
    print(f"é›²ç«¯ä¸Šå‚³é–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    date_str = datetime.now().strftime('%Y%m%d')
    with open(f"docs/podcast/{date_str}_{os.getenv('PODCAST_MODE', 'tw')}/archive_audio_url.txt", 'w') as f:
        f.write("https://example.com/audio.mp3")
    print(f"âœ… ä¸Šå‚³å®Œæˆ")
    with open("logs/upload_manager.log", "w") as f:
        f.write(f"{datetime.now()}: Upload completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/upload_manager.py
          if [ $? -ne 0 ]; then
            echo "âŒ é›²ç«¯ä¸Šå‚³å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/upload_manager.log"
            exit 1
          fi
          echo "âœ… é›²ç«¯ä¸Šå‚³å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/podcast/YYYYMMDD_*/archive_audio_url.txt: ls -la docs/podcast/$(date +%Y%m%d)_*/archive_audio_url.txt"
        continue-on-error: false
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}

  feed-publishing:
    runs-on: ubuntu-latest
    needs: upload-management
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Run Feed Publisher
        working-directory: repo
        run: |
          echo "ğŸ“¡ é–‹å§‹åŸ·è¡Œæ¨æ’­å“¡ (Feed Publisher) - æ¨¡å¼: $PODCAST_MODE"
          pwd  # é¡¯ç¤ºç•¶å‰å·¥ä½œç›®éŒ„
          ls -la scripts/  # æª¢æŸ¥ scripts ç›®éŒ„å…§å®¹
          mkdir -p docs/rss
          if [ ! -f "scripts/feed_publisher.py" ]; then
            echo "âš ï¸  feed_publisher.py ä¸å­˜åœ¨ï¼Œå‰µå»ºæ¨¡æ“¬è…³æœ¬"
            cat > scripts/feed_publisher.py << 'EOF'
import os
from datetime import datetime

def main():
    print(f"RSS ç™¼å¸ƒé–‹å§‹ - æ¨¡å¼: {os.getenv('PODCAST_MODE', 'tw')}")
    date_str = datetime.now().strftime('%Y%m%d')
    with open(f"docs/rss/podcast_{os.getenv('PODCAST_MODE', 'tw')}.xml", 'w') as f:
        f.write(f"<rss><channel><title>Podcast {os.getenv('PODCAST_MODE', 'tw')}</title></channel></rss>")
    print(f"âœ… RSS ç™¼å¸ƒå®Œæˆ")
    with open("logs/feed_publisher.log", "w") as f:
        f.write(f"{datetime.now()}: Feed publishing completed\n")

if __name__ == "__main__":
    main()
EOF
          fi
          python scripts/feed_publisher.py
          if [ $? -ne 0 ]; then
            echo "âŒ æ¨æ’­å“¡åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: cat logs/feed_publisher.log"
            exit 1
          fi
          echo "âœ… æ¨æ’­å“¡åŸ·è¡Œå®Œæˆï¼Œæª¢æŸ¥ docs/rss/podcast_*.xml: ls -la docs/rss/podcast_*.xml"
        continue-on-error: false
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # é¡å¤–æ­¥é©Ÿï¼Œæª¢æŸ¥æ‰€æœ‰æª”æ¡ˆä¸¦ä¸Šå‚³
  finalize:
    runs-on: ubuntu-latest
    needs: [data-collection, strategy-management, market-analysis, script-editing, podcast-production, upload-management, feed-publishing]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          path: repo
      - name: Check Podcast Files
        working-directory: repo
        run: |
          date_str=$(date +%Y%m%d)
          for mode in tw us; do
            for subfile in docs/podcast/${date_str}_${mode}/script.txt docs/podcast/${date_str}_${mode}/audio.mp3 docs/podcast/${date_str}_${mode}/archive_audio_url.txt; do
              if [ -f "$subfile" ]; then
                echo "$subfile exists, last modified: $(stat -c %y "$subfile")"
              else
                echo "Warning: $subfile does not exist"
              fi
            done
          done
          for rss in docs/rss/podcast_tw.xml docs/rss/podcast_us.xml docs/rss/podcast.xml; do
            if [ -f "$rss" ]; then
              echo "$rss exists, last modified: $(stat -c %y "$rss")"
            else
              echo "Warning: $rss does not exist"
            fi
          done
      - name: Commit and Push Changes
        working-directory: repo
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          date_str=$(date +%Y%m%d)
          for mode in tw us; do
            if [ -f "docs/podcast/${date_str}_${mode}/script.txt" ]; then
              git add docs/podcast/${date_str}_${mode}/script.txt
            fi
            if [ -f "docs/podcast/${date_str}_${mode}/audio.mp3" ]; then
              git add docs/podcast/${date_str}_${mode}/audio.mp3
            fi
            if [ -f "docs/podcast/${date_str}_${mode}/archive_audio_url.txt" ]; then
              git add docs/podcast/${date_str}_${mode}/archive_audio_url.txt
            fi
          done
          if [ -f "docs/rss/podcast_tw.xml" ]; then
            git add docs/rss/podcast_tw.xml
          fi
          if [ -f "docs/rss/podcast_us.xml" ]; then
            git add docs/rss/podcast_us.xml
          fi
          if [ -f "docs/rss/podcast.xml" ]; then
            git add docs/rss/podcast.xml
          fi
          git commit -m "Update podcast files [skip ci]" || echo "No changes to commit"
          git push
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: podcast-reports-${{ github.run_id }}
          path: |
            repo/docs/podcast/*/*_tw/script.txt
            repo/docs/podcast/*/*_tw/audio.mp3
            repo/docs/podcast/*/*_tw/archive_audio_url.txt
            repo/docs/podcast/*/*_us/script.txt
            repo/docs/podcast/*/*_us/audio.mp3
            repo/docs/podcast/*/*_us/archive_audio_url.txt
            repo/docs/rss/podcast_tw.xml
            repo/docs/rss/podcast_us.xml
            repo/docs/rss/podcast.xml
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
          include-hidden-files: false
