name: Upload Manager

on:
  schedule:
    # 每天 06:20 上傳美股檔案
    - cron: "20 22 * * *"  # UTC → 06:20 TPE
    # 每天 14:30 上傳台股檔案
    - cron: "30 6 * * *"   # UTC → 14:30 TPE
    # 每天 06:35 發佈美股 RSS Feed
    - cron: "35 22 * * *"  # UTC → 06:35 TPE
    # 每天 14:40 發佈台股 RSS Feed
    - cron: "40 6 * * *"   # UTC → 14:40 TPE

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Upload Manager
        run: |
          python scripts/upload_manager.py

  publish-feed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Publish Feed
        run: |
          if [ "$(date +'%H%M' -u)" == "2235" ]; then
            echo "📡 執行推播員 (mode=us)"
            PODCAST_MODE=us python scripts/feed_publisher.py
          elif [ "$(date +'%H%M' -u)" == "0640" ]; then
            echo "📡 執行推播員 (mode=tw)"
            PODCAST_MODE=tw python scripts/feed_publisher.py
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/rss/
          git commit -m "更新 Podcast RSS Feed"
          git push