name: Upload Manager

on:
  schedule:
    - cron: '0 22 * * *'   # UTC 22:00 → CST 06:00 → 上傳美股
    - cron: '30 6 * * *'   # UTC 06:30 → CST 14:30 → 上傳台股
  workflow_dispatch:
    inputs:
      mode:
        description: '上傳模式 (tw/us)'
        required: false
        default: 'tw'

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install b2sdk

      - name: Determine Mode
        id: set_mode
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            case "${{ github.event.schedule }}" in
              "0 22 * * *") MODE="us" ;;
              "30 6 * * *") MODE="tw" ;;
              *) MODE="tw" ;;
            esac
          else
            MODE="${{ github.event.inputs.mode }}"
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "📌 Upload Mode: $MODE"

      - name: Upload Podcast
        run: |
          echo "🚀 上傳 Podcast (mode=${{ steps.set_mode.outputs.mode }})"
          python scripts/upload_manager.py --mode ${{ steps.set_mode.outputs.mode }}
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}