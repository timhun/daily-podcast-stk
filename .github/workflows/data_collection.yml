name: Data Collection Pipeline

on:
  schedule:
    # 每4小時執行一次 (UTC時間)
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      market:
        description: 'Market to collect data from'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - taiwan
        - us
        - crypto
      cleanup:
        description: 'Run cleanup of old data'
        required: false
        default: false
        type: boolean

jobs:
  collect_data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        # 確保能推送更改
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create Required Directories
      run: |
        mkdir -p data/market
        mkdir -p data/news
        mkdir -p logs
        
    - name: Verify Project Structure
      run: |
        echo "=== 項目結構檢查 ==="
        echo "當前工作目錄: $(pwd)"
        echo "項目根目錄內容:"
        ls -la
        echo "檢查配置目錄:"
        if [ -d "config" ]; then
          echo "config 目錄存在"
          ls -la config/
        else
          echo "❌ config 目錄不存在"
        fi
        echo "檢查 scripts 目錄:"
        if [ -d "scripts" ]; then
          echo "scripts 目錄存在"
          ls -la scripts/
        else
          echo "❌ scripts 目錄不存在"
        fi
        
    - name: Test Configuration Loading
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "=== 配置載入測試 ==="
        python scripts/test_config.py
        
    - name: Run Data Collection
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "=== 開始數據收集 ==="
        python scripts/data_collector.py --market ${{ github.event.inputs.market || 'all' }} ${{ github.event.inputs.cleanup == 'true' && '--cleanup' || '' }}
        
    - name: Verify Data Collection Results
      run: |
        echo "=== 數據收集結果檢查 ==="
        echo "data/market 目錄內容:"
        if [ -d "data/market" ]; then
          ls -la data/market/
          echo "CSV 檔案數量: $(find data/market -name "*.csv" | wc -l)"
        else
          echo "❌ data/market 目錄不存在"
        fi
        
        echo "data/news 目錄內容:"
        if [ -d "data/news" ]; then
          find data/news -name "*.json" | head -5
          echo "新聞檔案數量: $(find data/news -name "*.json" | wc -l)"
        else
          echo "❌ data/news 目錄不存在"
        fi
        
        echo "logs 目錄內容:"
        if [ -d "logs" ]; then
          ls -la logs/
        fi
        
    - name: Upload Data Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: collected-data-${{ github.run_number }}
        path: |
          data/
          logs/
        retention-days: 7
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Commit and Push Changes
      run: |
        echo "=== Git 狀態檢查 ==="
        git status
        
        echo "=== 添加檔案到 Git ==="
        git add data/ logs/
        
        echo "=== 檢查是否有變更 ==="
        if ! git diff --cached --quiet; then
          echo "發現檔案變更，準備提交..."
          
          # 顯示將要提交的檔案
          echo "將要提交的檔案:"
          git diff --cached --name-only
          
          # 提交變更
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
          MARKET="${{ github.event.inputs.market || 'all' }}"
          
          git commit -m "📊 Data collection update ($MARKET) - $TIMESTAMP

          - Market: $MARKET
          - Workflow run: #${{ github.run_number }}
          - CSV files: $(find data/market -name "*.csv" 2>/dev/null | wc -l)
          - News files: $(find data/news -name "*.json" 2>/dev/null | wc -l)"
          
          echo "推送到 GitHub..."
          git push
          
          echo "✅ 數據已成功推送到 GitHub"
        else
          echo "沒有檔案變更，跳過提交"
        fi
        
    - name: Data Collection Summary
      if: always()
      run: |
        echo "=== 數據收集摘要 ==="
        echo "執行時間: $(date)"
        echo "市場範圍: ${{ github.event.inputs.market || 'all' }}"
        echo "清理舊數據: ${{ github.event.inputs.cleanup || 'false' }}"
        
        if [ -d "data/market" ]; then
          DAILY_COUNT=$(find data/market -name "daily_*.csv" 2>/dev/null | wc -l)
          HOURLY_COUNT=$(find data/market -name "hourly_*.csv" 2>/dev/null | wc -l)
          echo "日線數據檔案: $DAILY_COUNT"
          echo "小時線數據檔案: $HOURLY_COUNT"
        fi
        
        if [ -d "data/news" ]; then
          NEWS_COUNT=$(find data/news -name "*.json" 2>/dev/null | wc -l)
          echo "新聞檔案: $NEWS_COUNT"
        fi
        
        echo "Workflow 執行完成 🎉"
