name: Data Collection Pipeline

on:
  schedule:
    # æ¯4å°æ™‚åŸ·è¡Œä¸€æ¬¡ (UTCæ™‚é–“)
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      market:
        description: 'Market to collect data from'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - taiwan
        - us
        - crypto
      cleanup:
        description: 'Run cleanup of old data'
        required: false
        default: false
        type: boolean

jobs:
  collect_data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create Required Directories
      run: |
        mkdir -p data/market
        mkdir -p data/news
        mkdir -p logs
        
    - name: Run Data Collection
      env:
        # å¦‚æœä¹‹å¾Œéœ€è¦ API é‡‘é‘°ï¼Œåœ¨é€™è£¡æ·»åŠ 
        PYTHONPATH: ${{ github.workspace }}
      run: |
        cd scripts
        python data_collector.py --market ${{ github.event.inputs.market || 'all' }} ${{ github.event.inputs.cleanup == 'true' && '--cleanup' || '' }}
        
    - name: Upload Data Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: collected-data-${{ github.run_number }}
        path: |
          data/
          logs/
        retention-days: 7
        
    - name: Commit and Push Changes
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/ logs/
        
        # åªæœ‰åœ¨æœ‰è®Šæ›´æ™‚æ‰æäº¤
        if ! git diff --cached --quiet; then
          git commit -m "ğŸ“Š Data collection update - $(date +'%Y-%m-%d %H:%M')"
          git push
        else
          echo "No changes to commit"
        fi
