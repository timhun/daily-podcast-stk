name: Auto Trading Loop with Slack & LLM

on:
  schedule:
    - cron: "0 1 * * *"  # UTC 01:00 = 台灣 09:00
  workflow_dispatch:

jobs:
  run-trading:
    runs-on: ubuntu-latest
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}  # LLM API Key
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install slack_sdk yagmail grow-sdk

      - name: Run trading pipeline
        run: |
          python run_pipeline.py

      - name: Generate LLM Strategy (Grow)
        run: |
          python scripts/llm_strategy.py

      - name: Email daily report
        run: |
          python scripts/send_email.py \
            --to "Tim.oneway@gmail.com" \
            --subject "每日交易策略報告" \
            --body "請查閱附件的策略報告。" \
            --attach "output/report.pdf"

      - name: Send Slack notification
        run: |
          python - <<'PY'
          from slack_sdk import WebClient
          import os
          token = os.environ["SLACK_BOT_TOKEN"]
          channel = os.environ["SLACK_CHANNEL"]
          client = WebClient(token=token)
          message = "📊 今日自動交易策略已更新！請查看 GitHub 或附件。"
          client.chat_postMessage(channel=channel, text=message)
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-trading-report
          path: output/

      - name: Commit results
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "Auto update results $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push
