name: Generate TW Podcast

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'  # å°ç£æ™‚é–“ 15:00ï¼ˆUTC+8ï¼‰

jobs:
  podcast-tw:
    runs-on: ubuntu-latest
    concurrency:
      group: podcast-tw

    env:
      PODCAST_MODE: tw
      MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      GROK_API_URL: ${{ secrets.GROK_API_URL }}
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
      B2_BUCKET_NAME: daily-podcast-stk

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

      - name: Setup Python
        uses: actions/setup-python@v5  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
        with:
          python-version: '3.11'
          cache: 'pip'  # å•Ÿç”¨ pip å¿«å–ä»¥åŠ é€Ÿä¾è³´å®‰è£

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Step 1 - æ“·å–å°è‚¡å¸‚å ´è³‡æ–™ï¼ˆGrokï¼‰
        run: python scripts/fetch_tw_market_data_grok.py
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GROK_API_URL: ${{ secrets.GROK_API_URL }}

      - name: Step 2 - åˆ†æå¤šç©ºä¿¡è™Ÿ
        run: python scripts/analyze_bullish_signal_from_prompt.py

      - name: Step 3 - ç”¢ç”Ÿé€å­—ç¨¿è…³æœ¬
        run: python scripts/generate_script_tw.py

      - name: Step 4 - åˆæˆèªéŸ³
        run: python scripts/synthesize_audio.py

      - name: Step 5 - ä¸Šå‚³éŸ³æª”è‡³ B2
        run: python scripts/upload_to_b2.py

      - name: Step 6 - ç”¢ç”Ÿ RSS Feedï¼ˆTWï¼‰
        run: python scripts/generate_rss.py

      - name: Commit & Push (TW)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "ğŸ“¡ æ›´æ–° TW Podcast RSS" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push origin main || echo "âš ï¸ Push failed, please check manually"