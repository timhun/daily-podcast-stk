name: ğŸ§ å°è‚¡ Podcast è‡ªå‹•åŒ–ï¼ˆtwï¼‰

on:
  schedule:
    # å°ç£æ™‚é–“ 14:05 åŸ·è¡Œè³‡æ–™æ“·å–èˆ‡å¤šç©ºåˆ†æï¼ˆUTC+8 â†’ UTC 06:05ï¼‰
    - cron: '5 6 * * *'
    # å°ç£æ™‚é–“ 16:00 åŸ·è¡Œè…³æœ¬ç”¢å‡ºèˆ‡èªéŸ³åˆæˆï¼ˆUTC+8 â†’ UTC 08:00ï¼‰
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  podcast-tw:
    name: å°è‚¡ Podcast ç”¢è£½æµç¨‹
    runs-on: ubuntu-latest
    concurrency:
      group: podcast-tw
      cancel-in-progress: false

    env:
      PODCAST_MODE: tw

    steps:
      - name: ğŸ“¥ Checkout å°ˆæ¡ˆç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§  ç¬¬ä¸€æ­¥ï¼šå–å¾—å°è‚¡ JSON å¸‚å ´è³‡æ–™ï¼ˆGrokï¼‰
        run: python scripts/fetch_tw_market_data_grok.py

      - name: ğŸ§® ç¬¬äºŒæ­¥ï¼šç”¢å‡ºå¤šç©ºåˆ†æçµæœ
        run: python scripts/analyze_bullish_signal_from_prompt.py

      - name: ğŸ§­ åˆ¤æ–·æ˜¯å¦ç‚ºå°ç£å‡æ—¥ï¼ˆåªåœ¨å‡æ—¥ç•¥éå¾ŒçºŒæ­¥é©Ÿï¼‰
        id: holiday_check
        run: |
          python -c "
import sys
from scripts.utils_podcast_tw import is_tw_holiday
if is_tw_holiday():
    print('::set-output name=is_holiday::true')
else:
    print('::set-output name=is_holiday::false')
"
        shell: bash

      - name: âœï¸ ç¬¬ä¸‰æ­¥ï¼šç”¢å‡ºé€å­—ç¨¿ï¼ˆå‡æ—¥ä¹Ÿæ”¯æ´ holiday æ¨¡æ¿ï¼‰
        if: steps.holiday_check.outputs.is_holiday == 'false' || steps.holiday_check.outputs.is_holiday == 'true'
        run: python scripts/generate_script_tw.py

      - name: ğŸ—£ï¸ åˆæˆèªéŸ³
        if: steps.holiday_check.outputs.is_holiday == 'false'
        run: python scripts/synthesize_audio.py

      - name: â˜ï¸ ä¸Šå‚³éŸ³æª”è‡³ B2
        if: steps.holiday_check.outputs.is_holiday == 'false'
        run: python scripts/upload_to_b2.py

      - name: ğŸ“° ç”¢å‡º podcast_tw.xml
        if: steps.holiday_check.outputs.is_holiday == 'false'
        run: python scripts/generate_rss.py

      - name: ğŸ” åˆä½µ podcast.xmlï¼ˆtw+usï¼‰
        if: steps.holiday_check.outputs.is_holiday == 'false'
        run: python scripts/merge_rss_feeds.py

      - name: âœ… æ¨é€æ›´æ–°è‡³ GitHub Pages
        if: steps.holiday_check.outputs.is_holiday == 'false'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git pull --rebase
          git add .
          git commit -m "ğŸ¤– Update podcast_tw ${GITHUB_RUN_ID}" || echo "Nothing to commit"
          git push